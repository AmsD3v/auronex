{% extends "base.html" %}

{% block title %}Pagamento PIX - RoboTrader{% endblock %}

{% block content %}
<section class="py-5">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card shadow-lg">
                    <div class="card-body p-5 text-center">
                        <h3 class="mb-4">Pagamento via PIX</h3>
                        
                        <div class="alert alert-info mb-4">
                            <p class="mb-0"><strong>Plano:</strong> {{ plan.name }}</p>
                            <h4 class="mb-0 mt-2">R$ {{ "%.2f"|format(plan.price) }}</h4>
                        </div>
                        
                        <!-- QR Code Simulado -->
                        <div class="mb-4">
                            <div class="bg-white p-4 d-inline-block" style="border: 2px solid #28a745; border-radius: 10px;">
                                <div style="width: 250px; height: 250px; background: linear-gradient(45deg, #28a745, #20c997); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-qrcode fa-5x text-white"></i>
                                </div>
                            </div>
                        </div>
                        
                        <h6 class="mb-3">Ou copie o código PIX:</h6>
                        <div class="input-group mb-4">
                            <input type="text" class="form-control font-monospace" id="pix-code" value="00020126580014BR.GOV.BCB.PIX0114+55119999999990204000053039865802BR5925ROBOTRADER LTDA6009SAO PAULO62410503***50300017BR.GOV.BCB.BRCODE01051.0.063041D3D" readonly>
                            <button class="btn btn-success" onclick="copiarPix()">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        
                        <div class="alert alert-warning mb-4">
                            <i class="fas fa-clock"></i> Aguardando confirmação do pagamento...
                            <div class="spinner-border spinner-border-sm ms-2"></div>
                        </div>
                        
                        <p class="text-muted mb-4">
                            <small>Abra o app do seu banco, escaneie o QR Code ou cole o código acima.</small>
                        </p>
                        
                        <hr class="my-4">
                        
                        <div class="text-center">
                            <div class="spinner-border text-success mb-3"></div>
                            <p class="text-muted">
                                <i class="fas fa-clock"></i> Aguardando confirmação automática do pagamento...
                            </p>
                            <p class="small text-muted">Assim que você pagar, será redirecionado automaticamente!</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
// Ao carregar a página, gerar PIX REAL via MercadoPago
window.addEventListener('DOMContentLoaded', async function() {
    try {
        const urlParams = new URLSearchParams(window.location.search);
        const plan = urlParams.get('plan') || 'pro';
        
        // Chamar API PÚBLICA do MercadoPago (PRODUÇÃO - PAGAMENTO REAL!)
        const response = await fetch('/api/payments-public/mercadopago/pix', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                plan: plan
            }),
            credentials: 'include'  // Envia cookies (pending_user_id)
        });
        
        if (response.ok) {
            const data = await response.json();
            
            console.log('Resposta da API:', data);
            
            // Atualizar código PIX REAL
            if (data.pix_qr_code || data.pix_copy_paste) {
                const pixCode = data.pix_qr_code || data.pix_copy_paste;
                document.getElementById('pix-code').value = pixCode;
                console.log('PIX REAL atualizado!');
            }
            
            // Se tem QR Code em base64, mostrar imagem REAL
            if (data.pix_qr_code_base64) {
                const qrContainer = document.querySelector('.bg-white.p-4.d-inline-block');
                if (qrContainer) {
                    qrContainer.innerHTML = `<img src="data:image/png;base64,${data.pix_qr_code_base64}" alt="QR Code PIX" style="width: 250px; height: 250px;">`;
                    console.log('QR Code REAL mostrado!');
                }
            }
            
            // Iniciar polling
            if (data.payment_id) {
                startPolling(data.payment_id);
            }
        } else {
            console.log('API retornou erro:', await response.text());
        }
    } catch (error) {
        console.log('Erro ao chamar API:', error);
    }
});

function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
}

function copiarPix() {
    const input = document.getElementById('pix-code');
    input.select();
    document.execCommand('copy');
    alert('Código PIX copiado!');
}

// Verificação AUTOMÁTICA a cada 3 segundos
function startPolling(paymentId) {
    console.log('Iniciando polling automático para payment_id:', paymentId);
    
    const interval = setInterval(async () => {
        try {
            // Verificar status via webhook do MercadoPago
            const response = await fetch(`/api/payments-public/check-payment/${paymentId}`, {
                credentials: 'include'
            });
            
            if (response.ok) {
                const data = await response.json();
                console.log('Status do pagamento:', data.status);
                
                if (data.status === 'approved' || data.status === 'paid') {
                    clearInterval(interval);
                    console.log('Pagamento confirmado! Redirecionando...');
                    
                    // Redirecionar para success (vai logar automaticamente)
                    const plan = new URLSearchParams(window.location.search).get('plan') || 'pro';
                    window.location.href = '/payment/success?plan=' + plan + '&payment_confirmed=true';
                }
            }
        } catch (e) {
            console.log('Polling error:', e);
        }
    }, 3000);  // A cada 3 segundos
    
    // Parar após 15 minutos
    setTimeout(() => {
        clearInterval(interval);
        alert('Tempo de espera expirado. Se já pagou, clique em "Voltar" e tente novamente.');
    }, 900000);
}
</script>
{% endblock %}


